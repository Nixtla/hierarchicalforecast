



# <kbd>module</kbd> `hierarchicalforecast.probabilistic_methods`






---



## <kbd>class</kbd> `Normality`
Normality Probabilistic Reconciliation Class. 

The Normality method leverages the Gaussian Distribution linearity, to generate hierarchically coherent prediction distributions. This class is meant to be used as the `sampler` input as other `HierarchicalForecast` [reconciliation classes](https://nixtla.github.io/hierarchicalforecast/methods.html). 

Given base forecasts under a normal distribution: $$\hat{y}_{h} \sim \mathrm{N}(\hat{\boldsymbol{\mu}}, \hat{\mathbf{W}}_{h})$$ 

The reconciled forecasts are also normally distributed: 

$$ \tilde{y}_{h} \sim \mathrm{N}(\mathbf{S}\mathbf{P}\hat{\boldsymbol{\mu}}, \mathbf{S}\mathbf{P}\hat{\mathbf{W}}_{h} \mathbf{P}^{\intercal} \mathbf{S}^{\intercal}) $$ 



**Args:**
 
 - <b>`S`</b> (Union[np.ndarray, sp.spmatrix]):  np.array, summing matrix of size (`base`, `bottom`). 
 - <b>`P`</b> (Union[np.ndarray, sp.spmatrix]):  np.array, reconciliation matrix of size (`bottom`, `base`). 
 - <b>`y_hat`</b> (np.ndarray):  Point forecasts values of size (`base`, `horizon`). 
 - <b>`W`</b> (Union[np.ndarray, sp.spmatrix]):  np.array, hierarchical covariance matrix of size (`base`, `base`). 
 - <b>`sigmah`</b> (np.ndarray):  np.array, forecast standard dev. of size (`base`, `horizon`). 
 - <b>`seed`</b> (int, optional):  int, random seed for numpy generator's replicability. Default is 0. 

References: 
    - [Panagiotelis A., Gamakumara P. Athanasopoulos G., and Hyndman R. J. (2022). "Probabilistic forecast reconciliation: Properties, evaluation and score optimisation". European Journal of Operational Research.](https://www.sciencedirect.com/science/article/pii/S0377221722006087) 



### <kbd>method</kbd> `__init__`

```python
__init__(
    S: Union[ndarray, spmatrix],
    P: Union[ndarray, spmatrix],
    y_hat: ndarray,
    sigmah: ndarray,
    W: Union[ndarray, spmatrix],
    seed: int = 0
)
```








---



### <kbd>method</kbd> `get_prediction_levels`

```python
get_prediction_levels(res, level)
```

Adds reconciled forecast levels to results dictionary 



**Args:**
 
 - <b>`res`</b> (dict):  Results dictionary to update. 
 - <b>`level`</b> (list):  Confidence levels. 



**Returns:**
 
 - <b>`dict`</b>:  Updated results dictionary. 

---



### <kbd>method</kbd> `get_prediction_quantiles`

```python
get_prediction_quantiles(res, quantiles)
```

Adds reconciled forecast quantiles to results dictionary 



**Args:**
 
 - <b>`res`</b> (dict):  Results dictionary to update. 
 - <b>`quantiles`</b> (np.ndarray):  Quantiles to compute. 



**Returns:**
 
 - <b>`dict`</b>:  Updated results dictionary. 

---



### <kbd>method</kbd> `get_samples`

```python
get_samples(num_samples: int)
```

Normality Coherent Samples. 

Obtains coherent samples under the Normality assumptions. 



**Args:**
 
 - <b>`num_samples`</b> (int):  number of samples generated from coherent distribution. 



**Returns:**
 
 - <b>`np.ndarray`</b>:  samples: Coherent samples of size (`base`, `horizon`, `num_samples`). 


---



## <kbd>class</kbd> `Bootstrap`
Bootstrap Probabilistic Reconciliation Class. 

This method goes beyond the normality assumption for the base forecasts, the technique simulates future sample paths and uses them to generate base sample paths that are latered reconciled. This clever idea and its simplicity allows to generate coherent bootstraped prediction intervals for any reconciliation strategy. This class is meant to be used as the `sampler` input as other `HierarchicalForecast` [reconciliation classes](https://nixtla.github.io/hierarchicalforecast/methods.html). 

Given a boostraped set of simulated sample paths: $$(\hat{\mathbf{y}}^{[1]}_{\tau}, \dots ,\hat{\mathbf{y}}^{[B]}_{\tau})$$ 

The reconciled sample paths allow for reconciled distributional forecasts: $$(\mathbf{S}\mathbf{P}\hat{\mathbf{y}}^{[1]}_{\tau}, \dots ,\mathbf{S}\mathbf{P}\hat{\mathbf{y}}^{[B]}_{\tau})$$ 



**Args:**
 
 - <b>`S`</b>:  np.array, summing matrix of size (`base`, `bottom`). 
 - <b>`P`</b>:  np.array, reconciliation matrix of size (`bottom`, `base`). 
 - <b>`y_hat`</b>:  Point forecasts values of size (`base`, `horizon`). 
 - <b>`y_insample`</b>:  Insample values of size (`base`, `insample_size`). 
 - <b>`y_hat_insample`</b>:  Insample point forecasts of size (`base`, `insample_size`). 
 - <b>`num_samples`</b>:  int, number of bootstraped samples generated. 
 - <b>`seed`</b>:  int, random seed for numpy generator's replicability. 

References: 
    - [Puwasala Gamakumara Ph. D. dissertation. Monash University, Econometrics and Business Statistics (2020). "Probabilistic Forecast Reconciliation"](https://bridges.monash.edu/articles/thesis/Probabilistic_Forecast_Reconciliation_Theory_and_Applications/11869533) 
    - [Panagiotelis A., Gamakumara P. Athanasopoulos G., and Hyndman R. J. (2022). "Probabilistic forecast reconciliation: Properties, evaluation and score optimisation". European Journal of Operational Research.](https://www.sciencedirect.com/science/article/pii/S0377221722006087) 



### <kbd>method</kbd> `__init__`

```python
__init__(
    S: Union[ndarray, spmatrix],
    P: Union[ndarray, spmatrix],
    y_hat: ndarray,
    y_insample: ndarray,
    y_hat_insample: ndarray,
    num_samples: int = 100,
    seed: int = 0,
    W: Union[ndarray, spmatrix] = None
)
```








---



### <kbd>method</kbd> `get_prediction_levels`

```python
get_prediction_levels(res, level)
```

Adds reconciled forecast levels to results dictionary 

---



### <kbd>method</kbd> `get_prediction_quantiles`

```python
get_prediction_quantiles(res, quantiles)
```

Adds reconciled forecast quantiles to results dictionary 

---



### <kbd>method</kbd> `get_samples`

```python
get_samples(num_samples: int)
```

Bootstrap Sample Reconciliation Method. 

Applies Bootstrap sample reconciliation method as defined by Gamakumara 2020. Generating independent sample paths and reconciling them with Bootstrap. 



**Args:**
 
 - <b>`num_samples`</b>:  int, number of samples generated from coherent distribution. 



**Returns:**
 
 - <b>`samples`</b>:  Coherent samples of size (`base`, `horizon`, `num_samples`). 


---



## <kbd>class</kbd> `PERMBU`
PERMBU Probabilistic Reconciliation Class. 

The PERMBU method leverages empirical bottom-level marginal distributions with empirical copula functions (describing bottom-level dependencies) to generate the distribution of aggregate-level distributions using BottomUp reconciliation. The sample reordering technique in the PERMBU method reinjects multivariate dependencies into independent bottom-level samples. 

 Algorithm:  1.   For all series compute conditional marginals distributions.  2.   Compute residuals $\hat{\epsilon}_{i,t}$ and obtain rank permutations.  2.   Obtain K-sample from the bottom-level series predictions.  3.   Apply recursively through the hierarchical structure:<br/>  3.1.   For a given aggregate series $i$ and its children series:<br/>  3.2.   Obtain children's empirical joint using sample reordering copula.<br/>  3.2.   From the children's joint obtain the aggregate series's samples. 



**Args:**
 
 - <b>`S`</b>:  np.array, summing matrix of size (`base`, `bottom`). 
 - <b>`tags`</b>:  Each key is a level and each value its `S` indices. 
 - <b>`y_insample`</b>:  Insample values of size (`base`, `insample_size`). 
 - <b>`y_hat_insample`</b>:  Insample point forecasts of size (`base`, `insample_size`). 
 - <b>`sigmah`</b>:  np.array, forecast standard dev. of size (`base`, `horizon`). 
 - <b>`num_samples`</b>:  int, number of normal prediction samples generated. 
 - <b>`seed`</b>:  int, random seed for numpy generator's replicability. 

References: 
    - [Taieb, Souhaib Ben and Taylor, James W and Hyndman, Rob J. (2017). "Coherent probabilistic forecasts for hierarchical time series. International conference on machine learning ICML."](https://proceedings.mlr.press/v70/taieb17a.html) 



### <kbd>method</kbd> `__init__`

```python
__init__(
    S: Union[ndarray, spmatrix],
    tags: dict[str, ndarray],
    y_hat: ndarray,
    y_insample: ndarray,
    y_hat_insample: ndarray,
    sigmah: ndarray,
    num_samples: Optional[int] = None,
    seed: int = 0,
    P: Union[ndarray, spmatrix] = None
)
```








---



### <kbd>method</kbd> `get_prediction_levels`

```python
get_prediction_levels(res, level)
```

Adds reconciled forecast levels to results dictionary 

---



### <kbd>method</kbd> `get_prediction_quantiles`

```python
get_prediction_quantiles(res, quantiles)
```

Adds reconciled forecast quantiles to results dictionary 

---



### <kbd>method</kbd> `get_samples`

```python
get_samples(num_samples: Optional[int] = None)
```

PERMBU Sample Reconciliation Method. 

Applies PERMBU reconciliation method as defined by Taieb et. al 2017. Generating independent base prediction samples, restoring its multivariate dependence using estimated copula with reordering and applying the BottomUp aggregation to the new samples. 



**Args:**
 
 - <b>`num_samples`</b>:  int, number of samples generated from coherent distribution. 



**Returns:**
 
 - <b>`samples`</b>:  Coherent samples of size (`base`, `horizon`, `num_samples`). 



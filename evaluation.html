<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>hierarchicalforecast - Hierarchical Evaluation</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./favicon_png.png" rel="icon" type="image/png">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-NXJNCVR18L"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-NXJNCVR18L', { 'anonymize_ip': true});
</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="hierarchicalforecast - Hierarchical Evaluation">
<meta property="og:description" content="">
<meta property="og:site-name" content="hierarchicalforecast">
<meta name="twitter:title" content="hierarchicalforecast - Hierarchical Evaluation">
<meta name="twitter:description" content="">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">hierarchicalforecast</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link active" href="./examples/tourismsmall.html" rel="" target="" aria-current="page">
 <span class="menu-text">Get Started</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-nixtlaverse" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">NixtlaVerse</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-nixtlaverse">    
        <li>
    <a class="dropdown-item" href="https://github.com/nixtla/mlforecast" rel="" target="">
 <span class="dropdown-text">MLForecast ü§ñ</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://github.com/nixtla/neuralforecast" rel="" target="">
 <span class="dropdown-text">NeuralForecast üß†</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://github.com/nixtla/statsforecast" rel="" target="">
 <span class="dropdown-text">StatsForecast ‚ö°Ô∏è</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-help" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">Help</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-help">    
        <li>
    <a class="dropdown-item" href="https://github.com/nixtla/hierarchicalforecast/issues/new/choose" rel="" target=""><i class="bi bi-bug" role="img">
</i> 
 <span class="dropdown-text">Report an Issue</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://join.slack.com/t/nixtlacommunity/shared_invite/zt-1kd5m5db7-7OOfy0xVNf1PcvCiAPWvPw" rel="" target=""><i class="bi bi-chat-right-text" role="img">
</i> 
 <span class="dropdown-text">Join our Slack</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/nixtla/hierarchicalforecast" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/nixtlainc" rel="" target=""><i class="bi bi-twitter" role="img" aria-label="Nixtla Twitter">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./core.html">API Reference</a></li><li class="breadcrumb-item"><a href="./evaluation.html">Hierarchical Evaluation</a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Hierarchical Forecast üëë</span></a>
  </div>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="false">
 <span class="menu-text">Getting Started</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./examples/installation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Install</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./examples/tourismsmall.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Reconciliation Quick Start</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./examples/introduction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="false">
 <span class="menu-text">Tutorials</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="false">
 <span class="menu-text">Point Reconciliation</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./examples/australiandomestictourism.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Geographical Aggregation (Tourism)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./examples/australianprisonpopulation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Geographical Aggregation (Prison Population)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./examples/nonnegativereconciliation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Non-Negative MinTrace</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="false">
 <span class="menu-text">Probabilistic Reconciliation</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./examples/australiandomestictourism-intervals.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Normality</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./examples/australiandomestictourism-bootstraped-intervals.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bootstrap</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./examples/australiandomestictourism-permbu-intervals.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">PERMBU</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./examples/tourismlarge-evaluation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Probabilistic Forecast Evaluation</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="false">
 <span class="menu-text">ML Forecast Reconciliation</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./examples/hierarchicalforecast-gluonts.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">GluonTS</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./examples/mlframeworksexample.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Neural/MLForecast</span></a>
  </div>
</li>
      </ul>
  </li>
      </ul>
  </li>
        <li class="sidebar-item">
 <span class="menu-text">Methods</span>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true">
 <span class="menu-text">API Reference</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./core.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span style="color:DarkOrange"> Core </span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./methods.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span style="color:DarkOrange"> Reconciliation Methods </span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./probabilistic_methods.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span style="color:DarkOrange"> Probabilistic Methods </span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./evaluation.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Hierarchical Evaluation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./utils.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Aggregation/Visualization Utils</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="false">
 <span class="menu-text">Community</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
 <span class="menu-text">Contributing</span>
  </li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#accuracy-measurements" id="toc-accuracy-measurements" class="nav-link active" data-scroll-target="#accuracy-measurements"><span style="color:DarkBlue"> Accuracy Measurements </span></a>
  <ul class="collapse">
  <li><a href="#relative-mean-squared-error" id="toc-relative-mean-squared-error" class="nav-link" data-scroll-target="#relative-mean-squared-error">Relative Mean Squared Error</a>
  <ul class="collapse">
  <li><a href="#rel_mse" id="toc-rel_mse" class="nav-link" data-scroll-target="#rel_mse">rel_mse</a></li>
  </ul></li>
  <li><a href="#mean-squared-scaled-error" id="toc-mean-squared-scaled-error" class="nav-link" data-scroll-target="#mean-squared-scaled-error">Mean Squared Scaled Error</a>
  <ul class="collapse">
  <li><a href="#msse" id="toc-msse" class="nav-link" data-scroll-target="#msse">msse</a></li>
  </ul></li>
  <li><a href="#scaled-crps" id="toc-scaled-crps" class="nav-link" data-scroll-target="#scaled-crps">Scaled CRPS</a>
  <ul class="collapse">
  <li><a href="#scaled_crps" id="toc-scaled_crps" class="nav-link" data-scroll-target="#scaled_crps">scaled_crps</a></li>
  </ul></li>
  <li><a href="#energy-score" id="toc-energy-score" class="nav-link" data-scroll-target="#energy-score">Energy Score</a>
  <ul class="collapse">
  <li><a href="#energy_score" id="toc-energy_score" class="nav-link" data-scroll-target="#energy_score">energy_score</a></li>
  <li><a href="#log_score" id="toc-log_score" class="nav-link" data-scroll-target="#log_score">log_score</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#hierarchical-evaluation" id="toc-hierarchical-evaluation" class="nav-link" data-scroll-target="#hierarchical-evaluation"><span style="color:DarkBlue"> Hierarchical Evaluation </span></a>
  <ul class="collapse">
  <li><a href="#hierarchicalevaluation" id="toc-hierarchicalevaluation" class="nav-link" data-scroll-target="#hierarchicalevaluation">HierarchicalEvaluation</a></li>
  <li><a href="#hierarchicalevaluation.evaluate" id="toc-hierarchicalevaluation.evaluate" class="nav-link" data-scroll-target="#hierarchicalevaluation.evaluate">HierarchicalEvaluation.evaluate</a></li>
  </ul></li>
  <li><a href="#example" id="toc-example" class="nav-link" data-scroll-target="#example"><span style="color:DarkBlue"> Example </span></a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references"><span style="color:DarkBlue"> References </span></a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/Nixtla/hierarchicalforecast/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Hierarchical Evaluation</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<p>To assist the evaluation of hierarchical forecasting systems, we make available accuracy metrics along with the <a href="https://Nixtla.github.io/hierarchicalforecast/evaluation.html#hierarchicalevaluation"><code>HierarchicalEvaluation</code></a> module that facilitates the measurement of prediction‚Äôs accuracy through the hierarchy levels.</p>
<p>The available metrics include point and probabilistic multivariate scoring rules that were used in previous hierarchical forecasting studies.</p>
<section id="accuracy-measurements" class="level1">
<h1><span style="color:DarkBlue"> Accuracy Measurements </span></h1>
<section id="relative-mean-squared-error" class="level2">
<h2 class="anchored" data-anchor-id="relative-mean-squared-error">Relative Mean Squared Error</h2>
<hr>
<p><a href="https://github.com/Nixtla/hierarchicalforecast/blob/main/hierarchicalforecast/evaluation.py#L111" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="rel_mse" class="level3">
<h3 class="anchored" data-anchor-id="rel_mse">rel_mse</h3>
<blockquote class="blockquote">
<pre><code> rel_mse (y, y_hat, y_train, mask=None)</code></pre>
</blockquote>
<p>Relative Mean Squared Error</p>
<p>Computes Relative mean squared error (RelMSE), as proposed by Hyndman &amp; Koehler (2006) as an alternative to percentage errors, to avoid measure unstability.</p>
<p><span class="math display">\[ \mathrm{RelMSE}(\mathbf{y}, \mathbf{\hat{y}}, \mathbf{\hat{y}}^{naive1}) =
\frac{\mathrm{MSE}(\mathbf{y}, \mathbf{\hat{y}})}{\mathrm{MSE}(\mathbf{y}, \mathbf{\hat{y}}^{naive1})} \]</span></p>
<p><strong>Parameters:</strong><br> <code>y</code>: numpy array, Actual values of size (<code>n_series</code>, <code>horizon</code>).<br> <code>y_hat</code>: numpy array, Predicted values (<code>n_series</code>, <code>horizon</code>).<br> <code>mask</code>: numpy array, Specifies date stamps per serie to consider in loss.<br></p>
<p><strong>Returns:</strong><br> <code>loss</code>: float.</p>
<p><strong>References:</strong><br> - <a href="https://www.sciencedirect.com/science/article/pii/S0169207006000239">Hyndman, R. J and Koehler, A. B. (2006). ‚ÄúAnother look at measures of forecast accuracy‚Äù, International Journal of Forecasting, Volume 22, Issue 4.</a><br> - <a href="https://arxiv.org/pdf/2110.13179.pdf">Kin G. Olivares, O. Nganba Meetei, Ruijun Ma, Rohan Reddy, Mengfei Cao, Lee Dicker. ‚ÄúProbabilistic Hierarchical Forecasting with Deep Poisson Mixtures. Submitted to the International Journal Forecasting, Working paper available at arxiv.</a></p>
</section>
</section>
<section id="mean-squared-scaled-error" class="level2">
<h2 class="anchored" data-anchor-id="mean-squared-scaled-error">Mean Squared Scaled Error</h2>
<hr>
<p><a href="https://github.com/Nixtla/hierarchicalforecast/blob/main/hierarchicalforecast/evaluation.py#L148" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="msse" class="level3">
<h3 class="anchored" data-anchor-id="msse">msse</h3>
<blockquote class="blockquote">
<pre><code> msse (y, y_hat, y_train, mask=None)</code></pre>
</blockquote>
<p>Mean Squared Scaled Error</p>
<p>Computes Mean squared scaled error (MSSE), as proposed by Hyndman &amp; Koehler (2006) as an alternative to percentage errors, to avoid measure unstability.</p>
<p><span class="math display">\[ \mathrm{MSSE}(\mathbf{y}, \mathbf{\hat{y}}, \mathbf{y}^{in-sample}) =
\frac{\frac{1}{h} \sum^{t+h}_{\tau=t+1} (y_{\tau} - \hat{y}_{\tau})^2}{\frac{1}{t-1} \sum^{t}_{\tau=2} (y_{\tau} - y_{\tau-1})^2},\]</span></p>
<p>where <span class="math inline">\(n\)</span> (<span class="math inline">\(n=\)</span><code>n</code>) is the size of the training data, and <span class="math inline">\(h\)</span> is the forecasting horizon (<span class="math inline">\(h=\)</span><code>horizon</code>).</p>
<p><strong>Parameters:</strong><br> <code>y</code>: numpy array, Actual values of size (<code>n_series</code>, <code>horizon</code>).<br> <code>y_hat</code>: numpy array, Predicted values (<code>n_series</code>, <code>horizon</code>).<br> <code>y_train</code>: numpy array, Predicted values (<code>n_series</code>, <code>n</code>).<br> <code>mask</code>: numpy array, Specifies date stamps per serie to consider in loss.<br></p>
<p><strong>Returns:</strong><br> <code>loss</code>: float.</p>
<p><strong>References:</strong><br> - <a href="https://www.sciencedirect.com/science/article/pii/S0169207006000239">Hyndman, R. J and Koehler, A. B. (2006). ‚ÄúAnother look at measures of forecast accuracy‚Äù, International Journal of Forecasting, Volume 22, Issue 4.</a><br></p>
</section>
</section>
<section id="scaled-crps" class="level2">
<h2 class="anchored" data-anchor-id="scaled-crps">Scaled CRPS</h2>
<hr>
<p><a href="https://github.com/Nixtla/hierarchicalforecast/blob/main/hierarchicalforecast/evaluation.py#L186" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="scaled_crps" class="level3">
<h3 class="anchored" data-anchor-id="scaled_crps">scaled_crps</h3>
<blockquote class="blockquote">
<pre><code> scaled_crps (y, y_hat, quantiles)</code></pre>
</blockquote>
<p>Scaled Continues Ranked Probability Score</p>
<p>Calculates a scaled variation of the CRPS, as proposed by Rangapuram (2021), to measure the accuracy of predicted quantiles <code>y_hat</code> compared to the observation <code>y</code>.</p>
<p>This metric averages percentual weighted absolute deviations as defined by the quantile losses.</p>
<p><span class="math display">\[ \mathrm{sCRPS}(\hat{F}_{\tau}, \mathbf{y}_{\tau}) = \frac{2}{N} \sum_{i}
\int^{1}_{0}
\frac{\mathrm{QL}(\hat{F}_{i,\tau}, y_{i,\tau})_{q}}{\sum_{i} | y_{i,\tau} |} dq \]</span></p>
<p>where <span class="math inline">\(\hat{F}_{\tau}\)</span> is the an estimated multivariate distribution, and <span class="math inline">\(y_{i,\tau}\)</span> are its realizations.</p>
<p><strong>Parameters:</strong><br> <code>y</code>: numpy array, Actual values of size (<code>n_series</code>, <code>horizon</code>).<br> <code>y_hat</code>: numpy array, Predicted quantiles of size (<code>n_series</code>, <code>horizon</code>, <code>n_quantiles</code>).<br> <code>quantiles</code>: numpy array,(<code>n_quantiles</code>). Quantiles to estimate from the distribution of y.<br></p>
<p><strong>Returns:</strong><br> <code>loss</code>: float.</p>
<p><strong>References:</strong><br> - <a href="https://www.sciencedirect.com/science/article/pii/S0169207010000063">Gneiting, Tilmann. (2011). ‚ÄúQuantiles as optimal point forecasts‚Äù. International Journal of Forecasting.</a><br> - <a href="https://www.sciencedirect.com/science/article/pii/S0169207021001722">Spyros Makridakis, Evangelos Spiliotis, Vassilios Assimakopoulos, Zhi Chen, Anil Gaba, Ilia Tsetlin, Robert L. Winkler. (2022). ‚ÄúThe M5 uncertainty competition: Results, findings and conclusions‚Äù. International Journal of Forecasting.</a><br> - <a href="https://proceedings.mlr.press/v139/rangapuram21a.html">Syama Sundar Rangapuram, Lucien D Werner, Konstantinos Benidis, Pedro Mercado, Jan Gasthaus, Tim Januschowski. (2021). ‚ÄúEnd-to-End Learning of Coherent Probabilistic Forecasts for Hierarchical Time Series‚Äù. Proceedings of the 38th International Conference on Machine Learning (ICML).</a></p>
</section>
</section>
<section id="energy-score" class="level2">
<h2 class="anchored" data-anchor-id="energy-score">Energy Score</h2>
<hr>
<p><a href="https://github.com/Nixtla/hierarchicalforecast/blob/main/hierarchicalforecast/evaluation.py#L227" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="energy_score" class="level3">
<h3 class="anchored" data-anchor-id="energy_score">energy_score</h3>
<blockquote class="blockquote">
<pre><code> energy_score (y, y_sample1, y_sample2, beta=2)</code></pre>
</blockquote>
<p>Energy Score</p>
<p>Calculates Gneiting‚Äôs Energy Score sample approximation for <code>y</code> and independent multivariate samples <code>y_sample1</code> and <code>y_sample2</code>. The Energy Score generalizes the CRPS (<code>beta</code>=1) in the multivariate setting.</p>
<p><span class="math display">\[ \mathrm{ES}(\mathbf{y}_{\tau}, \mathbf{\hat{y}}_{\tau}, \mathbf{\hat{y}}_{\tau}')
= \frac{1}{2} \mathbb{E}_{\hat{P}} \left[ ||\mathbf{\hat{y}}_{\tau} - \mathbf{\hat{y}}_{\tau}'||^{\beta} \right]
-  \mathbb{E}_{\hat{P}} \left[ ||\mathbf{y}_{\tau} - \mathbf{\hat{y}}_{\tau}||^{\beta} \right]
\quad \beta \in (0,2]\]</span></p>
<p>where <span class="math inline">\(\mathbf{\hat{y}}_{\tau}, \mathbf{\hat{y}}_{\tau}'\)</span> are independent samples drawn from <span class="math inline">\(\hat{P}\)</span>.</p>
<p><strong>Parameters:</strong><br> <code>y</code>: numpy array, Actual values of size (<code>n_series</code>, <code>horizon</code>).<br> <code>y_sample1</code>: numpy array, predictive distribution sample of size (<code>n_series</code>, <code>horizon</code>, <code>n_samples</code>).<br> <code>y_sample2</code>: numpy array, predictive distribution sample of size (<code>n_series</code>, <code>horizon</code>, <code>n_samples</code>).<br> <code>beta</code>: float in (0,2], defines the energy score‚Äôs power for the euclidean metric.<br></p>
<p><strong>Returns:</strong><br> <code>score</code>: float.</p>
<p><strong>References:</strong><br> - <a href="https://sites.stat.washington.edu/raftery/Research/PDF/Gneiting2007jasa.pdf">Gneiting, Tilmann, and Adrian E. Raftery. (2007). ‚ÄúStrictly proper scoring rules, prediction and estimation‚Äù. Journal of the American Statistical Association.</a><br> - <a href="https://www.sciencedirect.com/science/article/pii/S0377221722006087">Anastasios Panagiotelis, Puwasala Gamakumara, George Athanasopoulos, Rob J. Hyndman. (2022). ‚ÄúProbabilistic forecast reconciliation: Properties, evaluation and score optimisation‚Äù. European Journal of Operational Research.</a></p>
<hr>
<p><a href="https://github.com/Nixtla/hierarchicalforecast/blob/main/hierarchicalforecast/evaluation.py#L271" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="log_score" class="level3">
<h3 class="anchored" data-anchor-id="log_score">log_score</h3>
<blockquote class="blockquote">
<pre><code> log_score (y, y_hat, cov, allow_singular=True)</code></pre>
</blockquote>
<p>Log Score.</p>
<p>One of the simplest multivariate probability scoring rules, it evaluates the negative density at the value of the realisation.</p>
<p><span class="math display">\[ \mathrm{LS}(\mathbf{y}_{\tau}, \mathbf{P}(\theta_{\tau}))
= - \log(f(\mathbf{y}_{\tau}, \theta_{\tau}))\]</span></p>
<p>where <span class="math inline">\(f\)</span> is the density, <span class="math inline">\(\mathbf{P}(\theta_{\tau})\)</span> is a parametric distribution and <span class="math inline">\(f(\mathbf{y}_{\tau}, \theta_{\tau})\)</span> represents its density. For the moment we only support multivariate normal log score.</p>
<p><span class="math display">\[f(\mathbf{y}_{\tau}, \theta_{\tau}) =
(2\pi )^{-k/2}\det({\boldsymbol{\Sigma }})^{-1/2}
\,\exp \left(
-{\frac {1}{2}}(\mathbf{y}_{\tau} -\hat{\mathbf{y}}_{\tau})^{\!{\mathsf{T}}}
{\boldsymbol{\Sigma }}^{-1}
(\mathbf{y}_{\tau} -\hat{\mathbf{y}}_{\tau})
\right)\]</span></p>
<p><strong>Parameters:</strong><br> <code>y</code>: numpy array, Actual values of size (<code>n_series</code>, <code>horizon</code>).<br> <code>y_hat</code>: numpy array, Predicted values (<code>n_series</code>, <code>horizon</code>).<br> <code>cov</code>: numpy matrix, Predicted values covariance (<code>n_series</code>, <code>n_series</code>, <code>horizon</code>).<br> <code>allow_singular</code>: bool=True, if true allows singular covariance.<br></p>
<p><strong>Returns:</strong><br> <code>score</code>: float.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.linspace(<span class="dv">0</span>, <span class="dv">5</span>, <span class="dv">10</span>, endpoint<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> multivariate_normal.pdf(x, mean<span class="op">=</span><span class="fl">2.5</span>, cov<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>y</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
</section>
<section id="hierarchical-evaluation" class="level1">
<h1><span style="color:DarkBlue"> Hierarchical Evaluation </span></h1>
<hr>
<p><a href="https://github.com/Nixtla/hierarchicalforecast/blob/main/hierarchicalforecast/evaluation.py#L309" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="hierarchicalevaluation" class="level3">
<h3 class="anchored" data-anchor-id="hierarchicalevaluation">HierarchicalEvaluation</h3>
<blockquote class="blockquote">
<pre><code> HierarchicalEvaluation (evaluators:List[Callable])</code></pre>
</blockquote>
<p>Hierarchical Evaluation Class.</p>
<p>You can use your own metrics to evaluate the performance of each level in the structure. The metrics receive <code>y</code> and <code>y_hat</code> as arguments and they are numpy arrays of size <code>(series, horizon)</code>. Consider, for example, the function <code>rmse</code> that calculates the root mean squared error.</p>
<p>This class facilitates measurements across the hierarchy, defined by the <code>tags</code> list. See also the <a href="https://nixtla.github.io/hierarchicalforecast/utils.html#aggregate">aggregate method</a>.</p>
<p><strong>Parameters:</strong><br> <code>evaluators</code>: functions with arguments <code>y</code>, <code>y_hat</code> (numpy arrays).<br></p>
<p><strong>References:</strong><br></p>
<hr>
<p><a href="https://github.com/Nixtla/hierarchicalforecast/blob/main/hierarchicalforecast/evaluation.py#L328" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="hierarchicalevaluation.evaluate" class="level3">
<h3 class="anchored" data-anchor-id="hierarchicalevaluation.evaluate">HierarchicalEvaluation.evaluate</h3>
<blockquote class="blockquote">
<pre><code> HierarchicalEvaluation.evaluate (Y_hat_df:pandas.core.frame.DataFrame,
                                  Y_test_df:pandas.core.frame.DataFrame,
                                  tags:Dict[str,numpy.ndarray], Y_df:Optio
                                  nal[pandas.core.frame.DataFrame]=None,
                                  benchmark:Optional[str]=None)</code></pre>
</blockquote>
<p>Hierarchical Evaluation Method.</p>
<p><strong>Parameters:</strong><br> <code>Y_hat_df</code>: pd.DataFrame, Forecasts indexed by <code>'unique_id'</code> with column <code>'ds'</code> and models to evaluate.<br> <code>Y_test_df</code>: pd.DataFrame, True values with columns <code>['ds', 'y']</code>.<br> <code>tags</code>: np.array, each str key is a level and its value contains tags associated to that level.<br> <code>Y_df</code>: pd.DataFrame, Training set of base time series with columns <code>['ds', 'y']</code> indexed by <code>unique_id</code>.<br> <code>benchmark</code>: str, If passed, evaluators are scaled by the error of this benchark.<br></p>
<p><strong>Returns:</strong><br> <code>evaluation</code>: pd.DataFrame with accuracy measurements across hierarchical levels.</p>
</section>
</section>
<section id="example" class="level1">
<h1><span style="color:DarkBlue"> Example </span></h1>
</section>
<section id="references" class="level1">
<h1><span style="color:DarkBlue"> References </span></h1>
<ul>
<li><a href="https://sites.stat.washington.edu/raftery/Research/PDF/Gneiting2007jasa.pdf">Gneiting, Tilmann, and Adrian E. Raftery. (2007). "Strictly proper scoring rules, prediction and estimation". Journal of the American Statistical Association.</a></li>
<li><a href="https://www.sciencedirect.com/science/article/pii/S0169207010000063">Gneiting, Tilmann. (2011). "Quantiles as optimal point forecasts". International Journal of Forecasting.</a></li>
<li><a href="https://www.sciencedirect.com/science/article/pii/S0169207021001722">Spyros Makridakis, Evangelos Spiliotis, Vassilios Assimakopoulos, Zhi Chen, Anil Gaba, Ilia Tsetlin, Robert L. Winkler. (2022). "The M5 uncertainty competition: Results, findings and conclusions". International Journal of Forecasting.</a></li>
<li><a href="https://www.sciencedirect.com/science/article/pii/S0377221722006087">Anastasios Panagiotelis, Puwasala Gamakumara, George Athanasopoulos, Rob J. Hyndman. (2022). "Probabilistic forecast reconciliation: Properties, evaluation and score optimisation". European Journal of Operational Research.</a></li>
<li><a href="https://proceedings.mlr.press/v139/rangapuram21a.html">Syama Sundar Rangapuram, Lucien D Werner, Konstantinos Benidis, Pedro Mercado, Jan Gasthaus, Tim Januschowski. (2021). "End-to-End Learning of Coherent Probabilistic Forecasts for Hierarchical Time Series". Proceedings of the 38th International Conference on Machine Learning (ICML).</a></li>
<li><a href="https://arxiv.org/pdf/2110.13179.pdf">Kin G. Olivares, O. Nganba Meetei, Ruijun Ma, Rohan Reddy, Mengfei Cao, Lee Dicker (2022). ‚ÄúProbabilistic Hierarchical Forecasting with Deep Poisson Mixtures‚Äù. Submitted to the International Journal Forecasting, Working paper available at arxiv.</a></li>
<li><a href="https://www.sciencedirect.com/science/article/pii/S0169207021001874">Makridakis, S., Spiliotis E., and Assimakopoulos V. (2022). ‚ÄúM5 Accuracy Competition: Results, Findings, and Conclusions.‚Äù, International Journal of Forecasting, Volume 38, Issue 4.</a></li>
</ul>


</section>

<p>If you find the code useful, please ‚≠ê us on <a href="https://github.com/nixtla/hierarchicalforecast">Github</a></p></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "Óßã";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>

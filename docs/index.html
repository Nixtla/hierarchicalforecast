---

title: Hierarchical ðŸ‘‘ Forecast


keywords: fastai
sidebar: home_sidebar



nb_path: "nbs/index.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/index.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><strong>HierarchicalForecast</strong> offers a collection of reconciliation methods, including <a href="/hierarchicalforecast/methods.html#BottomUp"><code>BottomUp</code></a>, <a href="/hierarchicalforecast/methods.html#TopDown"><code>TopDown</code></a>, <a href="/hierarchicalforecast/methods.html#MiddleOut"><code>MiddleOut</code></a>, <a href="/hierarchicalforecast/methods.html#MinTrace"><code>MinTrace</code></a> and <a href="/hierarchicalforecast/methods.html#ERM"><code>ERM</code></a>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="%F0%9F%8E%8A-Features">&#127882; Features<a class="anchor-link" href="#%F0%9F%8E%8A-Features"> </a></h2><ul>
<li>Classic reconciliation methods:<ul>
<li><a href="/hierarchicalforecast/methods.html#BottomUp"><code>BottomUp</code></a>: Simple addition to the upper levels.</li>
<li><a href="/hierarchicalforecast/methods.html#TopDown"><code>TopDown</code></a>: Distributes the top levels forecasts trough the hierarchies.</li>
</ul>
</li>
<li>Alternative reconciliation methods:<ul>
<li><a href="/hierarchicalforecast/methods.html#MiddleOut"><code>MiddleOut</code></a>: It anchors the base predictions in a middle level. The levels above the base predictions use the bottom-up approach, while the levels below use a top-down.</li>
<li><a href="/hierarchicalforecast/methods.html#MinTrace"><code>MinTrace</code></a>: Minimizes the total forecast variance of the space of coherent forecasts, with the Minimum Trace reconciliation.</li>
<li><a href="/hierarchicalforecast/methods.html#ERM"><code>ERM</code></a>: Optimizes the reconciliation matrix minimizing an L1 regularized objective.</li>
</ul>
</li>
</ul>
<p>Missing something? Please open an issue here or write us in <a href="https://join.slack.com/t/nixtlaworkspace/shared_invite/zt-135dssye9-fWTzMpv2WBthq8NK0Yvu6A"><img src="https://img.shields.io/badge/Slack-4A154B?&amp;logo=slack&amp;logoColor=white" alt="Slack"></a></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="%F0%9F%93%96-Why?">&#128214; Why?<a class="anchor-link" href="#%F0%9F%93%96-Why?"> </a></h2><p><strong>Short</strong>: We want to contribute to the ML field by providing reliable baselines and benchmarks for hierarchical forecasting task in industry and academia. Here's the complete <a href="https://arxiv.org/abs/2207.03517">paper</a>.</p>
<p><strong>Verbose</strong>: <code>HierarchicalForecast</code> integrates publicly available processed datasets, evaluation metrics, and a curated set of statistical baselines. In this library we provide usage examples and references to extensive experiments where we showcase the baseline's use and evaluate the accuracy of their predictions. With this work, we hope to contribute to Machine Learning forecasting by bridging the gap to statistical and econometric modeling, as well as providing tools for the development of novel hierarchical forecasting algorithms rooted in a thorough comparison of these well-established models. We intend to continue maintaining and increasing the repository, promoting collaboration across the forecasting community.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="%F0%9F%92%BB-Installation">&#128187; Installation<a class="anchor-link" href="#%F0%9F%92%BB-Installation"> </a></h2><h3 id="PyPI">PyPI<a class="anchor-link" href="#PyPI"> </a></h3><p>You can install the <em>released version</em> of <code>HierarchicalForecast</code> from the <a href="https://pypi.org">Python package index</a> with:</p>
<div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="n">hierarchicalforecast</span>
</pre></div>
<p>(Installing inside a python virtualenvironment or a conda environment is recommended.)</p>
<h3 id="Conda">Conda<a class="anchor-link" href="#Conda"> </a></h3><p>Also you can install the <em>released version</em> of <code>HierarchicalForecast</code> from <a href="https://anaconda.org">conda</a> with:</p>
<div class="highlight"><pre><span></span><span class="n">conda</span> <span class="n">install</span> <span class="o">-</span><span class="n">c</span> <span class="n">conda</span><span class="o">-</span><span class="n">forge</span> <span class="n">hierarchicalforecast</span>
</pre></div>
<p>(Installing inside a python virtualenvironment or a conda environment is recommended.)</p>
<h3 id="Dev-Mode">Dev Mode<a class="anchor-link" href="#Dev-Mode"> </a></h3><p>If you want to make some modifications to the code and see the effects in real time (without reinstalling), follow the steps below:</p>
<div class="highlight"><pre><span></span>git clone https://github.com/Nixtla/hierarchicalforecast.git
<span class="nb">cd</span> hierarchicalforecast
pip install -e .
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="%F0%9F%A7%AC-How-to-use">&#129516; How to use<a class="anchor-link" href="#%F0%9F%A7%AC-How-to-use"> </a></h2><p>The following example needs <code>statsforecast</code> and <code>datasetsforecast</code> as additional packages. If not installed, install it via your preferred method, e.g. <code>pip install statsforecast datasetsforecast</code>.
The <code>datasetsforecast</code> library allows us to download hierarhical datasets and we will use <code>statsforecast</code> to compute base forecasts to be reconciled.</p>
<p>You can open this example in Colab <a href="https://colab.research.google.com/github/nixtla/hierarchicalforecast/blob/main/examples/TourismSmall.ipynb"><img src="https://colab.research.google.com/assets/colab-badge.svg" alt="Open In Colab"></a></p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="c1">#obtain hierarchical dataset</span>
<span class="kn">from</span> <span class="nn">datasetsforecast.hierarchical</span> <span class="kn">import</span> <span class="n">HierarchicalData</span>
<span class="c1">#obtain hierarchical reconciliation methods and evaluation</span>
<span class="kn">from</span> <span class="nn">hierarchicalforecast.core</span> <span class="kn">import</span> <span class="n">HierarchicalReconciliation</span>
<span class="kn">from</span> <span class="nn">hierarchicalforecast.evaluation</span> <span class="kn">import</span> <span class="n">HierarchicalEvaluation</span>
<span class="kn">from</span> <span class="nn">hierarchicalforecast.methods</span> <span class="kn">import</span> <span class="n">BottomUp</span><span class="p">,</span> <span class="n">TopDown</span><span class="p">,</span> <span class="n">MiddleOut</span>
<span class="c1"># compute base forecast no coherent</span>
<span class="kn">from</span> <span class="nn">statsforecast.core</span> <span class="kn">import</span> <span class="n">StatsForecast</span>
<span class="kn">from</span> <span class="nn">statsforecast.models</span> <span class="kn">import</span> <span class="n">auto_arima</span><span class="p">,</span> <span class="n">naive</span>

<span class="c1"># Load TourismSmall dataset</span>
<span class="n">Y_df</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">tags</span> <span class="o">=</span> <span class="n">HierarchicalData</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;./data&#39;</span><span class="p">,</span> <span class="s1">&#39;TourismSmall&#39;</span><span class="p">)</span>
<span class="n">Y_df</span><span class="p">[</span><span class="s1">&#39;ds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">Y_df</span><span class="p">[</span><span class="s1">&#39;ds&#39;</span><span class="p">])</span>

<span class="c1">#split train/test sets</span>
<span class="n">Y_df_test</span> <span class="o">=</span> <span class="n">Y_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;unique_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
<span class="n">Y_df_train</span> <span class="o">=</span> <span class="n">Y_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">Y_df_test</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="n">Y_df_test</span> <span class="o">=</span> <span class="n">Y_df_test</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;unique_id&#39;</span><span class="p">)</span>
<span class="n">Y_df_train</span> <span class="o">=</span> <span class="n">Y_df_train</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;unique_id&#39;</span><span class="p">)</span>

<span class="c1"># Compute base auto-ARIMA predictions</span>
<span class="n">fcst</span> <span class="o">=</span> <span class="n">StatsForecast</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">Y_df_train</span><span class="p">,</span> <span class="n">models</span><span class="o">=</span><span class="p">[(</span><span class="n">auto_arima</span><span class="p">,</span><span class="mi">12</span><span class="p">),</span> <span class="n">naive</span><span class="p">],</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">Y_hat_df</span> <span class="o">=</span> <span class="n">fcst</span><span class="o">.</span><span class="n">forecast</span><span class="p">(</span><span class="n">h</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

<span class="c1"># Reconcile the base predictions</span>
<span class="n">reconcilers</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">BottomUp</span><span class="p">(),</span>
    <span class="n">TopDown</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;forecast_proportions&#39;</span><span class="p">),</span>
    <span class="n">MiddleOut</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;Country/Purpose/State&#39;</span><span class="p">,</span> <span class="n">top_down_method</span><span class="o">=</span><span class="s1">&#39;forecast_proportions&#39;</span><span class="p">)</span>
<span class="p">]</span>
<span class="n">hrec</span> <span class="o">=</span> <span class="n">HierarchicalReconciliation</span><span class="p">(</span><span class="n">reconcilers</span><span class="o">=</span><span class="n">reconcilers</span><span class="p">)</span>
<span class="n">Y_rec_df</span> <span class="o">=</span> <span class="n">hrec</span><span class="o">.</span><span class="n">reconcile</span><span class="p">(</span><span class="n">Y_hat_df</span><span class="p">,</span> <span class="n">Y_df_train</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Evaluation">Evaluation<a class="anchor-link" href="#Evaluation"> </a></h3><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">mse</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">y_hat</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">y</span><span class="o">-</span><span class="n">y_hat</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

<span class="n">evaluator</span> <span class="o">=</span> <span class="n">HierarchicalEvaluation</span><span class="p">(</span><span class="n">evaluators</span><span class="o">=</span><span class="p">[</span><span class="n">mse</span><span class="p">])</span>
<span class="n">evaluator</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">Y_h</span><span class="o">=</span><span class="n">Y_rec_df</span><span class="p">,</span> <span class="n">Y_test</span><span class="o">=</span><span class="n">Y_df_test</span><span class="p">,</span> 
                   <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">,</span> <span class="n">benchmark</span><span class="o">=</span><span class="s1">&#39;naive&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="How-to-cite">How to cite<a class="anchor-link" href="#How-to-cite"> </a></h2><p>Here's the complete <a href="https://arxiv.org/abs/2207.03517">paper</a>.</p>
<div class="highlight"><pre><span></span><span class="nc">@article</span><span class="p">{</span><span class="nl">olivares2022hierarchicalforecast</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="na">author</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="s">{Kin G. Olivares and</span>
<span class="s">                 Federico Garza and </span>
<span class="s">                 David Luo and </span>
<span class="s">                 Cristian ChallÃº and</span>
<span class="s">                 Max Mergenthaler}</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="na">title</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="s">{HierarchicalForecast: A Python Benchmarking Framework for Hierarchical Forecasting}</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="na">journal</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="s">{Computing Research Repository}</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="na">volume</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="s">{abs/2207.03517}</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="na">year</span><span class="w">      </span><span class="p">=</span><span class="w"> </span><span class="s">{2022}</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="na">url</span><span class="w">       </span><span class="p">=</span><span class="w"> </span><span class="s">{https://arxiv.org/abs/2207.03517}</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="na">archivePrefix</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">{arXiv}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>

</div>
</div>
</div>
</div>


